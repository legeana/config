#!/bin/bash
# Usage: readmanga <url>
# where 'url' is like 'http://readmanga.ru/x_day/vol2/10?mature='

get_urls()
{
    for i
    do
        #curl -s "$i" | grep pics | sed 1q | perl -pe 's/.*?url:"(.*?)".*?}(];)?/\1\n/g'
        curl -s "$i" | grep 'var pics' | sed -nr 's|^.*\[([^]]+)\].*$|\1|g;s|,||g;s|\{||g;s|\}|\n|gp' | sed -r 's|url:"([^"]+)".*|\1|g'
    done
}

wget_all()
{
    for c in `seq 0 "$((${#chapt[@]}-1))"`
    do
        for i in `seq ${chapt[$c]}`
        do
            get_urls `printf "$site" "$name" "$((c+from))" "$i"` | (mkdir -p "${root}/$((c+from))/${i}" && cd "${root}/$((c+from))/${i}" && wget -i - ) &
            #echo get_urls `printf "$site" "$name" "$((c+from))" "$i"`
        done
    done
}

wget_manga()
{
    debug=""
    if [ "$1" = "-d" ]
    then
        debug="1"
        shift
    fi
    order="cat"
    if [ "$1" = "-c" ]
    then
        cont="1"
        order="tac"
        shift
    fi
    manga="$1"
    manga_site_name="$(echo "$manga" | sed -r 's|(http://)?([^/]*)/([^/?]+)(\?.*)?$|\2:\3|')"
    manga_name="$(echo "$manga_site_name" | cut -d: -f2)"
    site="$(echo "$manga_site_name" | cut -d: -f1)"
    #site="$(echo "$1" | sed -r 's|^(http://)?([^/]*)/.*|\2|g')"
    #for chap in `curl -s "$manga" | sed -nr 's/^[[:space:]]*<a href="([^"]*)" title="[^"]*">.*<\/a>[[:space:]]*$/\1/gp'`
    for chap in `curl -s "$manga" | sed -nr 's|^[[:space:]]*<a href="(/'"$manga_name"'/vol[[:digit:]]+/[[:digit:]]+(\?mature=1?)?)" title="[^"]*">.*<\/a>[[:space:]]*$|\1|gp' | sort | uniq | $order`
    do
        dir="$(echo "$chap"  | sed -r 's|^/[^/]*/vol([[:digit:]]+)/([[:digit:]]+)[^[:digit:]].*$|\1/\2|g')"
        if [ "$debug" ]
        then
            echo get_urls "$site$chap"
        else
            #get_urls "$site$chap" | (mkdir -p "$dir" && cd "$dir" && wget -c -i -)
            all="$(get_urls "$site$chap")"
            size="$( echo "$(echo "$all" | wc -l | wc -c )-1" | bc )"
            ind="1"
            for url in $all
            do
                if echo "$url" | egrep "^[^[:space:]]+$" 2>&1 >/dev/null
                then
                    ext="$(echo "$url" | sed -r 's|^.*(\.[^.]*)$|\1|')"
                    cur_name="$(printf "%0${size}d\n" "$ind")$ext"
                    #( mkdir -p "$dir" && cd "$dir" && wget -c -o "$cur_name" "$url" )
                    printf "[\"%s\"->\"%s/%s\"]\n" "$url" "$dir"  "$cur_name"
                    ( mkdir -p "$dir" && cd "$dir" && curl --ftp-pasv --progress-bar -C - "$url" -o "$cur_name" )
                    ret="$?"
                    if [ "$cont" ]
                    then
                        if [ "$ret" -eq "33" ]
                        then
                            exit 33
                        fi
                    fi
                    #( mkdir -p "$dir" && cd "$dir" && curl --ftp-pasv -C - "$url" > "$cur_name" )
                    ind="$(echo "$ind+1" | bc)"
                fi
            done
        fi
    done
}

wget_manga "$@"

