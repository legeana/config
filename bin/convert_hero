#!/bin/sh

set -e

#ZOOM="320"
ZOOM="480"
#OAC="mp3lame"
#slow
#ME="esa"
ME="umh"
#ME="hex"
#ME="dia"
THREADS="1"
BITRATE="512"
ABITRATE="128"
FPS="25"
SWS="10"

FF_VC="copy"
FF_AC="aac"

OF="lavf"
OF_N="-lavfopts"
OF_O="format=mp4"

#BITRATE_N="bitrate"
#OVC="x264"
#OVC_N="-x264encopts"
#OVC_O="subq=7:frameref=6:me=${ME}:partitions=all:bframes=1:cabac:weightb:deblock"

BITRATE_N="vbitrate"
ABITRATE_N="abitrate"
OVC="lavc"
OVC_N="-lavcopts"
#OVC_O="vcodec=mpeg4:vme=8:mbd=2:autoaspect"
#OVC_O="aglobal=1:vglobal=1:acodec=libfaac:abitrate=192:vcodec=mpeg4:autoaspect:mbd=2:mv0:trell:v4mv:cbp:last_pred=3:predia=2:dia=2:precmp=2:cmp=2:subcmp=2:preme=2:turbo"
#OVC_O="aglobal=1:vglobal=1:"
#OVC_O="${OVC_O}acodec=libfaac:vcodec=mpeg4:autoaspect:mbd=2:mv0:trell:v4mv:cbp:last_pred=3:predia=2:dia=2:precmp=2:cmp=2:subcmp=2:preme=2:subq=8"
OVC_O="${OVC_O}vcodec=mpeg4:autoaspect:mbd=2:mv0:trell:v4mv:cbp:last_pred=3:predia=2:dia=2:precmp=2:cmp=2:subcmp=2:preme=2:subq=8"
#OVC_O="${OVC_O}acodec=libmp3lame:vcodec=mpeg4:autoaspect:mbd=2:mv0:trell:v4mv:cbp:last_pred=3:predia=2:dia=2:precmp=2:cmp=2:subcmp=2:preme=2:subq=8"

#OAC="faac"
#OAC_N="-faacopts"
#OAC_O="br=192"

#OAC="mp3lame"
#OAC_N="-lameopts"
#OAC_O="br=192"
#OAC_O="preset=extreme"

#OAC="lavc"

#moved to ffmpeg
OAC="pcm"

SRATE="48000"
#AF="lavcresample=$SRATE,volnorm=2:0.25"
AF="volnorm=2:0.25"

#VF="harddup,scale=$ZOOM:240"
#VF="harddup,scale=$ZOOM:-3,expand=$ZOOM:240"
#VF="harddup,scale=$ZOOM:-3"
VF="scale=$ZOOM:-3"

ATOM_OPTS=""

ALANG="ja,jp,jpn,Jap"
SLANG="ru,rus,Rus"

SUB="/dev/null"
ASS_SUB=""

PASS_COUNT="2"

convert_ass(){
	ASS_SUB="`mktemp`"
	cat "$SUB" | sed -r "s|\{.*\}||" >"$ASS_SUB"
	SUB="$ASS_SUB"
}

while getopts "o:s:a:l:t:i:b:f:n:p:v:enkm:qd" arg
do
	case "$arg" in
		o) OUTPUT="$OPTARG";;
		s) SUB="$OPTARG";;
		a) ALANG="$OPTARG";;
		i) ATOM_OPTS="$ATOM_OPTS -aid $OPTARG";;
		l) SLANG="$OPTARG";;
		t) THREADS="$OPTARG";;
		e) ASS_SUB="1";;
		b) BITRATE="$OPTARG";;
		f) FPS="$OPTARG";;
		p) PASS_COUNT="$OPTARG";;
		v) VF="$VF,$OPTARG";;
		n) ATOM_OPTS="$ATOM_OPTS -mc 0 -noskip";;
		k) ATOM_OPTS="$ATOM_OPTS -noskip";;
		m) ATOM_OPTS="$ATOM_OPTS -mc $OPTARG";;
		q) ATOM_OPTS="$ATOM_OPTS -quiet";;
		d) DEBUG="1";;
		?) printf "Usage: %s: [-o output ] [-s subtitles ] [-a alang ] [-l slang ] [-t threads ] [-e use ass ] [-b bitrate [$BITRATE]] [-f fps [$FPS]] [-p pass count [$PASS_COUNT]] [-v vf ] [-n noskip mc=0 ] [-k noskip ] [-m mc ] [-q quiet ] [-d debug ] input_list ...\n" "$0" 1>&2 && exit 1;;
	esac
done
shift "$(echo "$OPTIND" - 1 | bc)"

#OVC_O="$OVC_O:threads=$THREADS:$BITRATE_N=$BITRATE:$ABITRATE_N=$ABITRATE"
OVC_O="$OVC_O:threads=$THREADS:$BITRATE_N=$BITRATE"

LOG_FILE="`mktemp`"
TMP_FILE="`mktemp --suffix=.avi`"
#TMP_FILE="`basename "$OUTPUT"`.avi"

if [ "$ASS_SUB" ]; then
	convert_ass
	trap "rm -f -- '$LOG_FILE' '$TMP_FILE' '$ASS_SUB'" EXIT
else
	trap "rm -f -- '$LOG_FILE' '$TMP_FILE'" EXIT
fi

do_command(){
	if [ "$DEBUG" ]; then
		echo "$@"
	fi
	"$@"
}

do_pass(){
	do_command mencoder -msgcolor -ofps "$FPS" -sws "$SWS" -vf "$VF" -oac "$OAC" -ovc "$OVC" "$OVC_N" "$OVC_O$PASS" -passlogfile "$LOG_FILE" -o "$P_OUTPUT" -subcp "enca:ru:ISO-8859-1" -alang "ja,jp,jpn,Jap" -slang "ru,rus,Rus" -sub "$SUB" $ATOM_OPTS "$@"

	#mencoder -msgcolor -ofps "$FPS" -of "$OF" "$OF_N" "$OF_O" -af "$AF" -srate "$SRATE" -sws "$SWS" -vf "$VF" -oac "$OAC" -ovc "$OVC" "$OVC_N" "$OVC_O$PASS" -quiet -passlogfile "$LOG_FILE" -o "$P_OUTPUT" -subcp "enca:ru:ISO-8859-1" -alang "ja,jp,jpn,Jap" -slang "ru,rus,Rus" -sub "$SUB" $ATOM_OPTS "$@"
	#mencoder -msgcolor -ofps "$FPS" -af "$AF" -srate "$SRATE" -sws "$SWS" -vf "$VF" -oac "$OAC" -ovc "$OVC" "$OVC_N" "$OVC_O$PASS" -passlogfile "$LOG_FILE" -o "$P_OUTPUT" -subcp "enca:ru:ISO-8859-1" -alang "ja,jp,jpn,Jap" -slang "ru,rus,Rus" -sub "$SUB" $ATOM_OPTS "$@"
	#mencoder -msgcolor -af "$AF" -srate "$SRATE" -sws "$SWS" -vf "$VF" -oac "$OAC" -ovc "$OVC" "$OVC_N" "$OVC_O$PASS" -passlogfile "$LOG_FILE" -o "$P_OUTPUT" -subcp "enca:ru:ISO-8859-1" -alang "ja,jp,jpn,Jap" -slang "ru,rus,Rus" -sub "$SUB" $ATOM_OPTS "$@"
	#mencoder -msgcolor -sws "$SWS" -vf "$VF" -oac "$OAC" -ovc "$OVC" "$OVC_N" "$OVC_O$PASS" -passlogfile "$LOG_FILE" -o "$P_OUTPUT" -subcp "enca:ru:ISO-8859-1" -alang "ja,jp,jpn,Jap" -slang "ru,rus,Rus" -sub "$SUB" $ATOM_OPTS "$@"
	#ffmpeg -i "$@" -r 29.97 -vcodec h264 -s 480x320 -aspect 16:9 -flags +loop -cmp +chroma -deblockalpha 0 -deblockbeta 0 -b 1000k -maxrate 1250k -bufsize 4M -bt 256k -refs 1 -coder 0 -me umh -me_range 16 -subq 7 -partitions +parti4x4+parti8x8+partp8x8 -g 250 -keyint_min 25 -level 30 -qmin 10 -qmax 51 -qcomp 0.6 -trellis 2 -sc_threshold 40 -i_qfactor 0.71 -acodec aac -ab 80k -ar 48000 -ac 2 "$OUTPUT"
}

print_head(){
	foreground="$1"
	shift
	background="$1"
	shift
	text="$@"
	fill="$(echo "$text" | sed -r 's|.|#|g')"
	echo "###${fill}###"
	echo "## $(color "$foreground" "$background" )$text$(color off) ##"
	echo "###${fill}###"
}

if [ "$PASS_COUNT" -eq "1" ]; then
	PASS=""
	P_OUTPUT="$TMP_FILE"
	do_pass "$@"
else
	print_head ltyellow red First pass
	PASS=":vpass=1"
	P_OUTPUT="/dev/null"
	if [ "$OVC" == "lavc" -a "$PASS_COUNT" -eq "2" ]; then
		PASS="$PASS:turbo"
	fi
	do_pass "$@"
	if [ "$PASS_COUNT" -eq "2" ]; then
		PASS=":vpass=2"
		P_OUTPUT="$TMP_FILE"
		print_head ltyellow red Second pass
		do_pass "$@"
	else
		PASS=":vpass=3"
		print_head ltyellow red Second pass
		do_pass "$@"
		P_OUTPUT="$TMP_FILE"
		print_head ltyellow red Third pass
		do_pass "$@"
	fi
fi

#ffmpeg -y -i "$TMP_FILE" -vcodec copy -acodec copy "$OUTPUT"
do_command ffmpeg -y -i "$TMP_FILE" -vcodec "$FF_VC" -acodec "$FF_AC" -ab "${ABITRATE}k" "$OUTPUT"
#smth wrong with libfaac and mp4 ffmpeg -y -i "$TMP_FILE" -vcodec copy -acodec libfaac -ab "${ABITRATE}k" "$OUTPUT"

